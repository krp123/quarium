<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<window xmlns="http://schemas.haulmont.com/cuba/screen/window.xsd"
        xmlns:app="http://schemas.company.com/demo/0.1/ui-component.xsd"
        caption="msg://extChecklistEdit.caption"
        messagesPack="com.company.quarium.web.screens.checklist">
    <data>
        <instance id="checklistDc"
                  class="com.company.quarium.entity.checklist.Checklist">
            <view extends="project-checklist-view">
                <property name="assignedQa" view="qaProjectRelationship-view"/>
                <property name="state" view="_minimal"/>
                <property name="testCase" view="testCase-edit"/>
                <property name="module" view="edit"/>
            </view>
            <loader/>
            <collection id="testCasesDc" property="testCase"/>
        </instance>
        <collection id="entitylogsDc"
                    class="com.haulmont.cuba.security.entity.EntityLogItem"
                    view="logView">
            <loader id="entityLogItemsDl">
                <query><![CDATA[select i from sec$EntityLog i where i.entityRef.entityId = :checklist
                                    order by i.eventTs]]>
                </query>
            </loader>
            <collection id="logAttrDc"
                        property="attributes"/>
        </collection>
        <collection id="testCaseLogsDc"
                    class="com.haulmont.cuba.security.entity.EntityLogItem"
                    view="logView">
            <loader id="testCaseLogItemsDl">
                <query><![CDATA[select i from sec$EntityLog i where i.entityRef.entityId in :testCases
                                    order by i.eventTs]]>
                </query>
            </loader>
            <collection id="testCaseLogAttrDc"
                        property="attributes"/>
        </collection>
        <collection id="stepLogsDc"
                    class="com.haulmont.cuba.security.entity.EntityLogItem"
                    view="logView">
            <loader id="stepLogItemsDl">
                <query><![CDATA[select i from sec$EntityLog i where i.entityRef.entityId in :steps
                                    order by i.eventTs]]>
                </query>
            </loader>
            <collection id="stepLogAttrDc"
                        property="attributes"/>
        </collection>
        <collection id="statesDc" class="com.company.quarium.entity.references.Statement" view="_minimal">
            <loader id="statesDl">
                <query>
                    <![CDATA[select e from quarium_Statement e]]>
                </query>
            </loader>
        </collection>
        <collection id="prioritiesDc" class="com.company.quarium.entity.references.Priority" view="_minimal">
            <loader id="prioritiesDl">
                <query>
                    <![CDATA[select e from quarium_Priority e]]>
                </query>
            </loader>
        </collection>
        <instance id="testCaseDc"
                  class="com.company.quarium.entity.checklist.TestCase">
            <view extends="testCase-view">
                <property name="priority" view="_minimal"/>
                <property name="state" view="_minimal"/>
                <property name="caseStep" view="step-view"/>
            </view>
            <loader id="testCaseDl"/>
            <collection id="stepsCollection" property="caseStep"/>
        </instance>
    </data>
    <actions>
        <action id="save" icon="icons/ok.png" caption="mainMsg://actions.Ok" shortcut="CTRL-ENTER"/>
        <action id="cancel" icon="icons/cancel.png" caption="mainMsg://actions.Cancel" description="Esc"/>
        <action id="getEstimation"/>
    </actions>
    <dialogMode height="600"
                width="800"/>
    <layout expand="tabsheet" spacing="true">
        <tabSheet id="tabsheet">
            <tab id="detailsTab" caption="msg://checklistEdit.details" spacing="true" margin="true">
                <vbox spacing="true">
                    <groupBox spacing="true" width="100%" collapsable="true" caption="msg://checklistEdit.general">
                        <grid spacing="true" width="100%">
                            <columns>
                                <column flex="4"/>
                                <column flex="2"/>
                                <column flex="7"/>
                            </columns>
                            <rows>
                                <row>
                                    <textField id="nameField" dataContainer="checklistDc" property="name"
                                               caption="msg://checklistEdit.name"
                                               width="90%" required="true"/>
                                    <lookupField id="assignedQaField" dataContainer="checklistDc"
                                                 property="assignedQa" caption="msg://checklistEdit.QA"
                                                 width="90%"/>
                                    <textArea id="commentField" dataContainer="checklistDc"
                                              property="comment" caption="msg://checklistEdit.comment"
                                              width="80%" rowspan="2" rows="4"/>
                                </row>
                                <row>
                                    <lookupField id="stateField" dataContainer="checklistDc" optionsContainer="statesDc"
                                                 property="state" caption="msg://checklistEdit.State"
                                                 width="90%" required="true"/>
                                    <lookupField id="moduleField" dataContainer="checklistDc"
                                                 property="module" caption="msg://checklistEdit.module"
                                                 width="90%"/>
                                </row>
                                <row>
                                    <hbox spacing="true" caption="msg://checklistEdit.ticket" width="90%">
                                        <app:linkField id="ticket" dataContainer="checklistDc" property="ticket"
                                                       maxTextLength="40"/>
                                    </hbox>
                                    <hbox/>
                                    <textArea id="initialContitionsField" dataContainer="checklistDc"
                                              property="initialConditions"
                                              caption="msg://checklistEdit.initialConditions"
                                              width="80%" rowspan="2" rows="4" height="100%"/>
                                </row>
                                <row>
                                    <hbox caption="msg://checklistEdit.estimation" width="90%" spacing="true"
                                          expand="checklistMinLabel">
                                        <textField id="checklistHours" property="hours" width="50"
                                                   dataContainer="checklistDc" required="true"/>
                                        <label value="msg://checklistEdit.hoursLabel" align="BOTTOM_LEFT"
                                               width="20"/>
                                        <textField id="checklistMinutes" property="minutes" width="50"
                                                   dataContainer="checklistDc" required="true"/>
                                        <label id="checklistMinLabel" value="msg://checklistEdit.minutesLabel"
                                               align="BOTTOM_LEFT"/>
                                        <button action="getEstimation" id="button"
                                                width="AUTO" caption="msg://checklistEdit.getEstimation"
                                                description="Заполнить поле 'Оценка' суммой оценок тест-кейсов"
                                                align="MIDDLE_RIGHT"/>
                                    </hbox>
                                </row>
                            </rows>
                        </grid>
                    </groupBox>
                    <groupBox id="testCaseBox" caption="msg://checklistEdit.testCaseBox">
                        <split id="split" height="100%" orientation="horizontal"
                               reversePosition="true" width="100%" pos="70">
                            <vbox id="lookupBox" expand="table" height="100%" margin="false,true,false,false"
                                  spacing="true">
                                <table id="table"
                                       width="100%"
                                       dataContainer="testCasesDc"
                                       multiselect="false"
                                       presentations="true">
                                    <actions>
                                        <action id="create" type="create"/>
                                        <action id="edit" type="edit"/>
                                        <action id="remove" type="remove"/>
                                        <action id="moveTestCaseUp"/>
                                        <action id="moveTestCaseDown"/>
                                    </actions>
                                    <columns>
                                        <column id="number" editable="false" width="20"/>
                                        <column id="name" maxTextLength="20" expandRatio="100"/>
                                        <column id="priority" collapsed="true"/>
                                        <column id="state" collapsed="true"/>
                                    </columns>
                                    <rowsCount/>
                                    <buttonsPanel id="buttonsPanel"
                                                  alwaysVisible="true">
                                        <button id="createBtn" action="table.create" caption=""/>
                                        <button id="editBtn" action="table.edit" caption=""/>
                                        <button id="removeBtn" action="table.remove" caption=""/>
                                        <button id="testCaseUp" caption="" action="table.moveTestCaseUp"
                                                icon="font-icon:ANGLE_UP"/>
                                        <button id="testCaseDown" caption="" action="table.moveTestCaseDown"
                                                icon="font-icon:ANGLE_DOWN"/>
                                    </buttonsPanel>
                                </table>
                            </vbox>
                            <vbox id="editBox" height="100%" margin="true,false,false,true" expand="fieldGroupBox"
                                  spacing="true">
                                <scrollBox id="fieldGroupBox" width="100%">
                                    <grid id="caseForm" spacing="true" width="100%">
                                        <columns>
                                            <column flex="2"/>
                                            <column flex="1"/>
                                        </columns>
                                        <rows>
                                            <row>
                                                <textField id="caseNameField" property="name"
                                                           dataContainer="testCaseDc"
                                                           caption="msg://checklistEdit.caseName"
                                                           width="90%"/>
                                                <hbox caption="msg://checklistEdit.estimation" spacing="true">
                                                    <textField id="caseHours" property="hours"
                                                               dataContainer="testCaseDc" width="50"/>
                                                    <label id="testCaseHoursLabel"
                                                           value="msg://checklistEdit.hoursLabel" align="BOTTOM_LEFT"
                                                           width="20"/>
                                                    <textField id="caseMinutes" property="minutes"
                                                               dataContainer="testCaseDc" width="50"/>
                                                    <label id="testCaseMinLabel"
                                                           value="msg://checklistEdit.minutesLabel"
                                                           align="BOTTOM_LEFT"/>
                                                </hbox>
                                            </row>
                                            <row>
                                                <textArea id="initialConditions" dataContainer="testCaseDc"
                                                          property="initialConditions"
                                                          caption="msg://checklistEdit.initialConditions" width="90%"
                                                          rows="2"/>

                                                <lookupField id="priorityField" dataContainer="testCaseDc"
                                                             optionsContainer="prioritiesDc" property="priority"
                                                             caption="msg://checklistEdit.priority" width="90%"/>
                                            </row>
                                            <row>
                                                <table id="stepsTable"
                                                       dataContainer="stepsCollection"
                                                       width="90%"
                                                       responsive="true"
                                                       multiselect="true"
                                                       columnHeaderVisible="false"
                                                       caption="msg://checklistEdit.steps"
                                                       multiLineCells="true"
                                                       editable="true"
                                                       rowspan="3">
                                                    <actions>
                                                        <action id="createStep" type="create"/>
                                                        <action id="removeStep" type="remove"/>
                                                        <action id="moveStepUp"/>
                                                        <action id="moveStepDown"/>
                                                    </actions>
                                                    <columns>
                                                        <column id="number" editable="false" width="20"/>
                                                        <column id="step" editable="true"/>
                                                    </columns>
                                                    <buttonsPanel>
                                                        <button action="stepsTable.createStep" caption=""
                                                                icon="ADD_TO_SET_ACTION"
                                                                primary="false"/>
                                                        <button action="stepsTable.removeStep" caption=""
                                                                icon="REMOVE_ACTION"/>
                                                        <button id="stepUp" caption="" action="stepsTable.moveStepUp"
                                                                icon="font-icon:ANGLE_UP"/>
                                                        <button id="stepDown" caption=""
                                                                action="stepsTable.moveStepDown"
                                                                icon="font-icon:ANGLE_DOWN"/>
                                                    </buttonsPanel>
                                                </table>
                                                <!--                                                <lookupField id="caseStateField" dataContainer="testCaseDc"-->
                                                <!--                                                             optionsContainer="statesDc" property="state"-->
                                                <!--                                                             caption="msg://checklistEdit.state" width="90%"/>-->

                                                <lookupField id="caseResult"
                                                             dataContainer="testCaseDc"
                                                             property="result"
                                                             caption="msg://checklistEdit.result" width="90%"/>
                                            </row>
                                            <row>
                                                <dateField id="checkDate" dataContainer="testCaseDc"
                                                           property="checkDate" caption="msg://checklistEdit.checkDate"
                                                           visible="false"/>
                                            </row>
                                            <row>
                                                <hbox id="ticketBox" spacing="true"
                                                      caption="msg://checklistEdit.caseTicket"
                                                      width="90%"
                                                      visible="false">
                                                    <app:linkField id="caseTicket" dataContainer="testCaseDc"
                                                                   property="ticket"
                                                                   maxTextLength="40"/>
                                                </hbox>
                                            </row>
                                            <row>
                                                <richTextArea id="expectedResultField" property="expectedResult"
                                                              dataContainer="testCaseDc"
                                                              caption="msg://checklistEdit.expectedResult" width="90%"/>
                                                <richTextArea id="caseComment" dataContainer="testCaseDc"
                                                              property="comment" width="90%"
                                                              caption="msg://checklistEdit.comment"
                                                              visible="false"/>
                                            </row>
                                        </rows>
                                    </grid>
                                </scrollBox>
                                <hbox id="actionsPane" spacing="true" visible="true">
                                    <button id="saveBtn" action="save"/>
                                    <button id="cancelBtn" action="cancel"/>
                                </hbox>
                            </vbox>
                        </split>
                    </groupBox>
                </vbox>
            </tab>
            <tab id="historyChanges" caption="msg://checklistEdit.historyChangesTab" spacing="true" margin="true">
                <table id="logTable"
                       dataContainer="entitylogsDc"
                       width="100%"
                       height="300px">
                    <columns>
                        <column id="eventTs"/>
                        <column id="user.login"/>
                        <column id="displayedEntityName" caption="msg://checklistEdit.entity"/>
                        <column id="type"/>
                    </columns>
                </table>
                <table id="attrTable"
                       height="300px"
                       width="100%"
                       dataContainer="logAttrDc">
                    <columns>
                        <column id="displayName"/>
                        <column id="oldValue"/>
                        <column id="value"/>
                    </columns>
                </table>
            </tab>
        </tabSheet>
        <hbox id="editActions" spacing="true">
            <button id="commitAndCloseBtn" action="windowCommitAndClose"/>
            <button id="closeBtn" action="windowClose"/>
        </hbox>
    </layout>
</window>
